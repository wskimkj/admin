<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>어드민</title>
  <link rel="icon" type="image/png" href="favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui, -apple-system, "Pretendard", sans-serif;
      background:#fdf2ff;
      overflow:hidden;
      font-size:14px;
    }

    .app-shell{
      position:relative;
      width:100%;
      height:100vh;
      overflow:hidden;
    }

    /* ===== main sidebar ===== */
    .main-sidebar{
      position:fixed;
      top:0; left:0;
      width:82px; height:100%;
      background:#b79cff;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 0;
      z-index:9999; /* ✅ 최상단 */
    }

    .nav-list{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      margin-top:4px;
    }

    .nav-item{
      width:60px;
      border:none;
      background:transparent;
      color:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      cursor:pointer;
      font-size:11px;
      font-weight:800;
      user-select:none;
    }

    .nav-icon-wrap{
      width:40px;height:40px;
      border-radius:16px;
      background:rgba(255,255,255,0.18);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 6px 14px rgba(15,23,42,0.20);
      transition:transform .15s ease;
    }
    .nav-item i{font-size:20px}
    .nav-item.active .nav-icon-wrap{
      background:#fff;
      color:#6d28d9;
    }
    .nav-item:hover .nav-icon-wrap{transform:translateY(-1px)}

    .nav-footer-btn{
      margin-bottom:8px;
      border:none;
      background:rgba(255,255,255,0.18);
      color:rgba(255,255,255,0.95);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:900;
      user-select:none;
    }
    .nav-footer-btn i{font-size:16px}

    /* ===== sub sidebar ===== */
    .sub-sidebar{
      position:fixed;
      left:96px;
      width:180px;
      border-radius:18px;
      padding:12px;
      background:rgba(255,255,255,0.85);
      border:1px solid rgba(15,23,42,0.10);
      box-shadow:0 18px 40px rgba(15,23,42,0.18);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      z-index:9998; /* ✅ main-sidebar 바로 아래 */
      display:none;
    }
    .sub-sidebar.visible{display:block}
    .sub-list{display:flex;flex-direction:column;gap:8px}
    .sub-item{
      width:100%;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.10);
      background:rgba(255,255,255,0.9);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      user-select:none;
    }
    .sub-item:hover{background:#fff}
    .sub-item i{font-size:16px;color:rgba(15,23,42,0.55)}

    /* ===== content ===== */
    .content{
      position:absolute;
      left:82px; top:0; right:0; bottom:0;
      padding:10px;
      z-index:1;
    }
    .card{
      width:100%;
      height:100%;
      border-radius:18px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 18px 40px rgba(15,23,42,0.12);
    }
    iframe{
      width:100%;
      height:100%;
      border:none;
      background:#fff;
    }

    /* ===== widgets ===== */
    .widget{
      position:fixed;
      left:96px;
      bottom:20px;
      width:340px;
      border-radius:18px;
      background:rgba(255,255,255,0.92);
      border:1px solid rgba(15,23,42,0.10);
      box-shadow:0 18px 40px rgba(15,23,42,0.20);
      padding:12px;
      z-index:9997;
      display:none;
    }
    .widget.visible{display:block}
    .widget-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .widget-title{font-weight:1000}
    .widget-close{
      border:none;
      width:30px;height:30px;
      border-radius:999px;
      cursor:pointer;
      background:#fff;
      box-shadow:0 10px 20px rgba(15,23,42,0.10);
      display:flex;align-items:center;justify-content:center;
    }

    /* phone */
    .phone-input{
      width:100%;
      border:1px solid rgba(15,23,42,0.12);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      outline:none;
    }
    .row{margin-top:10px;display:flex;gap:8px;align-items:center}
    .out{
      flex:1;
      border:1px solid rgba(15,23,42,0.12);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      user-select:none;
      cursor:copy;
      background:rgba(255,255,255,0.8);
    }
    .btn{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      font-weight:1000;
      box-shadow:0 10px 18px rgba(15,23,42,0.10);
    }
    .hint{margin-top:8px;font-size:11px;font-weight:900;color:rgba(15,23,42,0.55)}

    /* tracking */
    .tracking-frame-wrap{
      margin-top:10px;
      border:1px solid rgba(15,23,42,0.12);
      border-radius:14px;
      overflow:hidden;
      height:360px;
      background:#fff;
    }
    .tracking-frame{
      width:125%;
      height:125%;
      border:0;
      transform:scale(0.8);
      transform-origin:top left;
    }
  </style>
</head>

<body>
<div class="app-shell">

  <!-- main sidebar -->
  <nav class="main-sidebar">
    <div class="nav-list">
      <button class="nav-item active" data-id="search" data-href="https://wskimkj.github.io/search/">
        <div class="nav-icon-wrap"><i class='bx bx-search'></i></div>
        <span>상품</span>
      </button>

      <button class="nav-item" data-id="template" data-href="https://wskimkj.github.io/trim2/">
        <div class="nav-icon-wrap"><i class="bx bx-chat"></i></div>
        <span>멘트</span>
      </button>

      <button class="nav-item" data-id="order" data-href="https://wskimkj.github.io/return-inf/">
        <div class="nav-icon-wrap"><i class='bx bxs-basket'></i></div>
        <span>주문</span>
      </button>

      <button class="nav-item" data-id="memo" data-href="https://wskimkj.github.io/memo/">
        <div class="nav-icon-wrap"><i class="bx bx-edit-alt"></i></div>
        <span>메모</span>
      </button>

      <!-- util (sub) -->
      <button class="nav-item" id="utilBtn" data-id="util">
        <div class="nav-icon-wrap"><i class='bx bx-category'></i></div>
        <span>유틸</span>
      </button>

      <!-- google (sub) -->
      <button class="nav-item" id="googleBtn" data-id="google">
        <div class="nav-icon-wrap"><i class='bx bxs-cabinet'></i></div>
        <span>시트</span>
      </button>
    </div>

    <button class="nav-footer-btn" id="phoneBtn" type="button"><i class='bx bx-phone'></i><span>Phone</span></button>
    <button class="nav-footer-btn" id="trackBtn" type="button"><i class='bx bx-package'></i><span>Track</span></button>
    <button class="nav-footer-btn" id="accountBtn" type="button"><i class='bx bx-key'></i><span>ID/PW</span></button>
    <button class="nav-footer-btn" id="calendarBtn" type="button"><i class='bx bx-calendar-event'></i><span>Event</span></button>
  </nav>

  <!-- google sub sidebar -->
  <aside class="sub-sidebar" id="googleSidebar">
    <div class="sub-list">
      <button class="sub-item" data-href="https://docs.google.com/spreadsheets/d/1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM/edit?gid=366983013#gid=366983013">
        <i class='bx bx-chevron-right'></i><span>개인시트</span>
      </button>
      <button class="sub-item" data-href="https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/edit?gid=1265906605#gid=1265906605">
        <i class='bx bx-chevron-right'></i><span>반품</span>
      </button>
      <button class="sub-item" data-href="https://docs.google.com/spreadsheets/d/1Cjoo-x9lBA5pFtGoxftdAxdoKrzt770XcPGeXOidPiI/edit?gid=0#gid=0">
        <i class='bx bx-chevron-right'></i><span>Team.반품</span>
      </button>
      <button class="sub-item" data-href="https://docs.google.com/spreadsheets/d/1LPy69E2yPTaSwxFAYrX6qV0BZx1tW0YdonLRNqeo5Vc/edit?gid=0#gid=0">
        <i class='bx bx-chevron-right'></i><span>Team.물류</span>
      </button>
    </div>
  </aside>

  <!-- util sub sidebar -->
  <aside class="sub-sidebar" id="utilSidebar">
    <div class="sub-list">
      <button class="sub-item" data-action="openAccount">
        <i class='bx bx-chevron-right'></i><span>계정</span>
      </button>
      <button class="sub-item" data-action="openTrack">
        <i class='bx bx-chevron-right'></i><span>배송조회</span>
      </button>
      <button class="sub-item" data-href="https://wskimkj.github.io/refund24/">
        <i class='bx bx-chevron-right'></i><span>환불</span>
      </button>
      <button class="sub-item" data-action="openCalendar">
        <i class='bx bx-chevron-right'></i><span>이벤트</span>
      </button>
    </div>
  </aside>

  <!-- main content -->
  <div class="content">
    <div class="card">
      <iframe id="mainFrame" src="https://wskimkj.github.io/search/"></iframe>
    </div>
  </div>

  <!-- Phone widget -->
  <div class="widget" id="phoneWidget">
    <div class="widget-head">
      <div class="widget-title">Phone</div>
      <button class="widget-close" type="button" data-close="phoneWidget"><i class='bx bx-x'></i></button>
    </div>

    <input id="phoneInput" class="phone-input" placeholder="전화번호 입력 (숫자/문자 아무거나)" />
    <div class="row">
      <div id="phoneOutput" class="out"></div>
      <button id="phoneCopy" class="btn" type="button">복사</button>
    </div>
    <div id="phoneHint" class="hint">번호를 입력하세요</div>
  </div>

  <!-- Tracking widget -->
  <div class="widget" id="trackWidget" style="width:560px">
    <div class="widget-head">
      <div class="widget-title">Tracking</div>
      <button class="widget-close" type="button" data-close="trackWidget"><i class='bx bx-x'></i></button>
    </div>

    <div class="row" style="margin-top:0">
      <button class="btn carrier active" data-full="CJ대한통운" data-url="https://trace.cjlogistics.com/next/tracking.html?wblNo=">CJ</button>
      <button class="btn carrier" data-full="로젠택배" data-url="https://www.ilogen.com/web/personal/trace/">로젠</button>
      <button class="btn carrier" data-full="한진택배" data-url="https://www.hanjin.com/kor/CMS/DeliveryMgr/WaybillResult.do?mCode=MN038&schLang=KR&wblnumText2=">한진</button>
      <button class="btn carrier" data-full="우체국택배" data-url="https://service.epost.go.kr/trace.RetrieveDomRigiTraceList.comm?sid1=">우체국</button>
    </div>

    <div style="margin-top:10px;font-weight:1000;color:rgba(15,23,42,0.6);font-size:12px">운송장 번호</div>
    <input id="trackInput" class="phone-input" placeholder="숫자만 (8~15자리)" />

    <button id="trackGo" class="btn" style="margin-top:10px;width:100%" type="button">조회</button>
    <div id="trackMsg" class="hint" style="color:#e11d48;display:none"></div>

    <div id="trackHeader" class="hint" style="margin-top:10px"></div>
    <div class="tracking-frame-wrap">
      <iframe id="trackFrame" class="tracking-frame"></iframe>
    </div>
  </div>

  <!-- Account widget (지금은 “시트 열기 + 정상 토글”까지) -->
  <div class="widget" id="accountWidget" style="width:420px">
    <div class="widget-head">
      <div class="widget-title">Account</div>
      <button class="widget-close" type="button" data-close="accountWidget"><i class='bx bx-x'></i></button>
    </div>

    <div class="row" style="margin-top:0">
      <button id="accountOpenSheet" class="btn" type="button">ACCOUNT 시트 열기</button>
      <button id="accountOpenRowDemo" class="btn" type="button">행 점프 테스트</button>
    </div>

    <div class="hint" style="margin-top:10px">
      ✅ 여기까지는 “클릭/토글/시트열기/행점프”가 무조건 정상 작동하는 베이스야.<br>
      다음 단계에서 네 원래 “CSV 로딩 + 검색 + 카드 렌더”를 이 위에 안전하게 얹으면 돼.
    </div>
  </div>

  <!-- Calendar widget (지금은 시트만 열기 + 토글) -->
  <div class="widget" id="calendarWidget">
    <div class="widget-head">
      <div class="widget-title">Event</div>
      <button class="widget-close" type="button" data-close="calendarWidget"><i class='bx bx-x'></i></button>
    </div>
    <button id="eventSheetOpen" class="btn" type="button" style="width:100%">이벤트 시트 열기</button>
    <div class="hint" style="margin-top:10px">다음 단계에서 네 달력 UI를 그대로 이 위에 붙일 수 있어.</div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ✅ 콘솔에 이거 뜨면 스크립트 살아있는 거
  console.log("✅ admin v2 script alive");

  /* ===== constants (선언 순서 중요) ===== */
  const LAST_FRAME_KEY = "lastFrameURL";

  const ACCOUNT_SHEET_ID = "1bdGBLki_3CVaq7BDL3u-pQDSZVBD7roeEdsyP-74Lz0";
  const ACCOUNT_SHEET_BASE = `https://docs.google.com/spreadsheets/d/${ACCOUNT_SHEET_ID}/edit`;

  const EVENT_SHEET_URL =
    "https://docs.google.com/spreadsheets/d/1Cjoo-x9lBA5pFtGoxftdAxdoKrzt770XcPGeXOidPiI/edit?gid=1830278768#gid=1830278768";

  function openAccountSheetAt(gid, a1){
    const url = `${ACCOUNT_SHEET_BASE}?gid=${gid}#gid=${gid}&range=${encodeURIComponent(a1)}`;
    window.open(url, "_blank");
  }

  /* ===== DOM ===== */
  const mainFrame = document.getElementById("mainFrame");
  const navItems = document.querySelectorAll(".nav-item");

  const googleBtn = document.getElementById("googleBtn");
  const utilBtn = document.getElementById("utilBtn");
  const googleSidebar = document.getElementById("googleSidebar");
  const utilSidebar = document.getElementById("utilSidebar");

  const phoneBtn = document.getElementById("phoneBtn");
  const trackBtn = document.getElementById("trackBtn");
  const accountBtn = document.getElementById("accountBtn");
  const calendarBtn = document.getElementById("calendarBtn");

  const phoneWidget = document.getElementById("phoneWidget");
  const trackWidget = document.getElementById("trackWidget");
  const accountWidget = document.getElementById("accountWidget");
  const calendarWidget = document.getElementById("calendarWidget");

  /* ===== helpers ===== */
  function rememberFrame(url){ localStorage.setItem(LAST_FRAME_KEY, url); }
  function restoreLastFrame(){
    const last = localStorage.getItem(LAST_FRAME_KEY);
    mainFrame.src = last || "https://wskimkj.github.io/search/";
  }

  function hideAllSub(){
    googleSidebar.classList.remove("visible");
    utilSidebar.classList.remove("visible");
  }
  function hideAllWidgets(){
    phoneWidget.classList.remove("visible");
    trackWidget.classList.remove("visible");
    accountWidget.classList.remove("visible");
    calendarWidget.classList.remove("visible");
  }
  function closeAll(){
    hideAllSub();
    hideAllWidgets();
  }

  function placeSubSidebarNear(btn, panel){
    const r = btn.getBoundingClientRect();
    const panelH = panel.offsetHeight || 220;

    let top = r.top + (r.height/2) - (panelH/2);
    top = Math.max(12, Math.min(top, window.innerHeight - panelH - 12));

    panel.style.top = `${top}px`;
    panel.style.left = "96px";
  }

  function togglePanel(panel, anchorBtn){
    const open = panel.classList.contains("visible");
    closeAll();
    if(!open){
      panel.classList.add("visible");
      placeSubSidebarNear(anchorBtn, panel);
    }
  }

  function toggleWidget(w){
    const open = w.classList.contains("visible");
    hideAllSub();
    hideAllWidgets();
    if(!open) w.classList.add("visible");
  }

  /* ===== iframe restore ===== */
  restoreLastFrame();
  mainFrame.addEventListener("load", () => {
    rememberFrame(mainFrame.src);
  });

  /* ===== nav clicks ===== */
  navItems.forEach(btn => {
    btn.addEventListener("click", (e) => {
      const id = btn.dataset.id;
      const href = btn.dataset.href;

      // util/google는 하위 패널로만
      if(id === "util" || id === "google"){
        e.stopPropagation();
        return;
      }

      navItems.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      closeAll();
      if(href){
        mainFrame.src = href;
        rememberFrame(href);
      }
      e.stopPropagation();
    });
  });

  /* ===== sub sidebars toggle ===== */
  googleBtn.addEventListener("click", (e) => {
    togglePanel(googleSidebar, googleBtn);
    e.stopPropagation();
  });

  utilBtn.addEventListener("click", (e) => {
    togglePanel(utilSidebar, utilBtn);
    e.stopPropagation();
  });

  // sub-item iframe open
  googleSidebar.addEventListener("click", (e) => {
    const item = e.target.closest(".sub-item");
    if(!item) return;

    const url = item.dataset.href;
    if(url){
      mainFrame.src = url;
      rememberFrame(url);
    }
    closeAll();
    e.stopPropagation();
  });

  utilSidebar.addEventListener("click", (e) => {
    const item = e.target.closest(".sub-item");
    if(!item) return;

    const action = item.dataset.action;
    const url = item.dataset.href;

    if(action === "openAccount") toggleWidget(accountWidget);
    else if(action === "openTrack") toggleWidget(trackWidget);
    else if(action === "openCalendar") toggleWidget(calendarWidget);
    else if(url){
      mainFrame.src = url;
      rememberFrame(url);
      closeAll();
    }
    e.stopPropagation();
  });

  /* ===== widget buttons ===== */
  phoneBtn.addEventListener("click", (e)=>{ toggleWidget(phoneWidget); e.stopPropagation(); });
  trackBtn.addEventListener("click", (e)=>{ toggleWidget(trackWidget); e.stopPropagation(); });
  accountBtn.addEventListener("click", (e)=>{ toggleWidget(accountWidget); e.stopPropagation(); });
  calendarBtn.addEventListener("click", (e)=>{ toggleWidget(calendarWidget); e.stopPropagation(); });

  // close buttons
  document.querySelectorAll("[data-close]").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const id = btn.dataset.close;
      const el = document.getElementById(id);
      if(el) el.classList.remove("visible");
      e.stopPropagation();
    });
  });

  // widget 내부 클릭은 닫힘 방지
  [phoneWidget, trackWidget, accountWidget, calendarWidget, googleSidebar, utilSidebar].forEach(el=>{
    el.addEventListener("click", e=>e.stopPropagation());
  });

  // 바깥 클릭하면 sub/sidebar 닫기
  document.addEventListener("click", () => {
    hideAllSub();
  });

  // ESC 닫기
  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape") closeAll();
  });

  /* ===== Phone widget logic ===== */
  const phoneInput = document.getElementById("phoneInput");
  const phoneOutput = document.getElementById("phoneOutput");
  const phoneCopy = document.getElementById("phoneCopy");
  const phoneHint = document.getElementById("phoneHint");

  function formatKoreanPhone(input){
    let num = String(input ?? "").replace(/\D/g, "");
    if(num.startsWith("82")) num = "0" + num.slice(2);

    const SAFE_PREFIX = ["0502","0504","0505","0506","0507"];
    for(const p of SAFE_PREFIX){
      if(num.startsWith(p)){
        if(num.length === 11) return { type:"safe", value: num.replace(/(\d{4})(\d{3})(\d{4})/, "$1-$2-$3") };
        if(num.length === 12) return { type:"safe", value: num.replace(/(\d{4})(\d{4})(\d{4})/, "$1-$2-$3") };
      }
    }

    if(num.length === 10 && num.startsWith("10")) num = "0" + num;
    if(num.length === 11 && num.startsWith("010")){
      return { type:"mobile", value: num.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3") };
    }
    return { type:"unknown", value:"" };
  }

  phoneInput.addEventListener("input", ()=>{
    const r = formatKoreanPhone(phoneInput.value);
    if(r.value){
      phoneOutput.textContent = r.value;
      phoneHint.textContent = (r.type === "safe") ? "안전번호(가상번호)" : "휴대폰 번호";
    }else{
      phoneOutput.textContent = "";
      phoneHint.textContent = "번호를 입력하세요";
    }
  });

  async function copyText(v){
    if(!v) return;
    try{
      await navigator.clipboard.writeText(v);
      phoneHint.textContent = "복사됨 ✅";
    }catch{
      phoneHint.textContent = "복사 실패(브라우저 권한 확인)";
    }
  }

  phoneOutput.addEventListener("click", ()=> copyText(phoneOutput.textContent));
  phoneCopy.addEventListener("click", ()=> copyText(phoneOutput.textContent));

  /* ===== Tracking widget logic ===== */
  const carriers = trackWidget.querySelectorAll(".carrier");
  const trackInput = document.getElementById("trackInput");
  const trackGo = document.getElementById("trackGo");
  const trackMsg = document.getElementById("trackMsg");
  const trackHeader = document.getElementById("trackHeader");
  const trackFrame = document.getElementById("trackFrame");

  function getActiveCarrier(){
    return trackWidget.querySelector(".carrier.active");
  }

  carriers.forEach(b=>{
    b.addEventListener("click", (e)=>{
      carriers.forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      e.stopPropagation();
    });
  });

  function validateTracking(raw){
    const digits = String(raw || "").replace(/\s+/g,"");
    if(!digits) return "운송장 번호를 입력해주세요.";
    if(!/^\d{8,15}$/.test(digits)) return "운송장 번호는 숫자 8~15자리로 입력해주세요.";
    return "";
  }

  function doTrack(){
    const raw = trackInput.value.trim();
    const msg = validateTracking(raw);

    if(msg){
      trackMsg.style.display = "block";
      trackMsg.textContent = msg;
      trackHeader.textContent = "";
      trackFrame.src = "";
      return;
    }

    trackMsg.style.display = "none";
    const digits = raw.replace(/\s+/g,"");
    const c = getActiveCarrier();
    const full = c?.dataset?.full || "택배사";
    const base = c?.dataset?.url || "";
    trackHeader.innerHTML = `${full} 배송 조회 화면입니다.`;
    trackFrame.src = base + encodeURIComponent(digits);
  }

  trackGo.addEventListener("click", doTrack);
  trackInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doTrack(); });

  /* ===== Account widget ===== */
  document.getElementById("accountOpenSheet").addEventListener("click", () => {
    window.open(`${ACCOUNT_SHEET_BASE}#gid=0`, "_blank");
  });

  // ✅ 행 점프 테스트(더블클릭 점프랑 똑같은 로직)
  document.getElementById("accountOpenRowDemo").addEventListener("click", () => {
    // 예: gid 0의 A10으로 점프
    openAccountSheetAt(0, "A10");
  });

  /* ===== Calendar widget ===== */
  document.getElementById("eventSheetOpen").addEventListener("click", () => {
    window.open(EVENT_SHEET_URL, "_blank");
  });
});
</script>
</body>
</html>
